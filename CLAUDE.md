# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

BoilerMeets is a real-time video chat matching application with a monorepo structure containing:
- **Client**: React + TanStack Router + Vite frontend (runs on port 3000)
- **Server**: Express + Socket.IO + PostgreSQL backend
- Real-time matching system using Redis queue
- WebRTC video chat functionality with room management
- Authentication via Better Auth with email verification

## Architecture

### Client Architecture
- **Router**: TanStack Router with file-based routing in `client/src/routes/`
  - Route tree auto-generated in `routeTree.gen.ts`
  - Routes: login, register, dashboard, profile, chat-room, demo pages
- **State Management**: TanStack Query for server state
- **Styling**: Tailwind CSS v4 with shadcn/ui components
- **Real-time**: Socket.IO client connecting to `/room-finder` and `/video-chat` namespaces

### Server Architecture
- **Entry Point**: `server/src/index.ts` - Express server with Socket.IO on shared HTTP server
- **Database**: PostgreSQL with Drizzle ORM
  - Schema in `server/src/db/schema.ts`: users, sessions, accounts, verification, matches
  - Migrations generated/applied via drizzle-kit
- **Authentication**: Better Auth with email/password + username plugin
  - Email verification via nodemailer
  - Session management with DB adapter
- **Real-time Systems**:
  - **Room Finder** (`sockets/room-finder.ts`): Queue-based matching using Redis lists
  - **Video Chat** (`sockets/video-chat.ts`): WebRTC signaling and room management
  - **RoomManager** (`utils/room-manager.ts`): Redis-backed room state with automatic cleanup
- **Redis Adapter**: Socket.IO uses Redis pub/sub for horizontal scaling
- **Logging**: node-json-logger for structured logging

### Key Data Flows
1. **Matching**: User joins queue → `room-finder` namespace → paired via `getPair()` → room created in Redis → both users get `room-found` event with roomId
2. **Video Chat**: Users join `/video-chat` namespace with roomId → WebRTC signaling (offer/answer/ICE) → post-call actions (match/call-again) stored in Redis
3. **Room Lifecycle**: Rooms stored in Redis hash `room:{roomId}` → auto-cleanup hourly for rooms >24h old

## Development Commands

### Initial Setup
```bash
# Install dependencies in both directories
cd client && npm install
cd ../server && npm install

# Install global dependencies (if needed)
npm install -g nodemon ts-node

# Setup PostgreSQL database
docker run --name boilermeets-local -e POSTGRES_PASSWORD=<PASSWORD> -p 5432:5432 -d postgres:latest
```

### Database Commands (run in `server/` directory)
```bash
# Generate migration files from schema changes
npx drizzle-kit generate

# Apply migrations to database
npx drizzle-kit migrate
```

### Running the Application
```bash
# Client (from client/ directory)
npm run start        # Development mode on port 3000
npm run build        # Production build
npm run test         # Run vitest tests

# Server (from server/ directory)
npm run dev          # Development mode with nodemon
npm run build        # Build TypeScript to dist/
npm start            # Run production build
```

## Environment Configuration

### server/.env
```
DATABASE_URL="postgresql://postgres:<PASSWORD>@localhost:5432"
PORT=<VALID_HTTP_PORT>
BETTER_AUTH_SECRET=<RANDOM_UUID>
BETTER_AUTH_URL="http://localhost:3000"
EMAIL_USER="ibtemp99@gmail.com"
GOOGLE_APP_PASSWORD=<ASK_IAN_FOR_THIS>
```

### client/.env
```
VITE_SERVER_URL="http://localhost:<SERVER_PORT>"
```

## Component Guidelines

### Adding shadcn/ui Components
Use the latest version of shadcn to install components:
```bash
pnpx shadcn@latest add button
```

### Client Path Aliases
- `@/` resolves to `client/src/`
- Example: `import { Button } from '@/components/ui/button'`

## Important Implementation Details

### Socket.IO Namespaces
- `/room-finder`: Handles user queueing and room matching
- `/video-chat`: Handles WebRTC signaling and room interactions
- Both require `userId` in `socket.handshake.auth`

### Redis Data Structures
- `room-finder:queue` (list): User IDs waiting for matches
- `room` (hash): Room data by roomId (user1, user2, createdAt)
- `call-again:{roomId}` (hash): Per-user call-again preferences
- `match:{roomId}` (hash): Per-user match preferences

### Better Auth Configuration
- Email verification required for new signups
- Additional user fields: major, year, bio, birthdate
- Session cookie cache disabled for better control
- Username plugin enabled

### Database Schema Notes
- User table uses text IDs (generated by Better Auth)
- Matches table uses serial IDs with foreign keys to users
- All timestamp fields have automatic `$onUpdate` handlers
